<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OneDrive File Editor</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 300px; margin-top: 20px; }
    button { margin: 10px 5px; padding: 10px 15px; border: none; background: #0078d4; color: white; border-radius: 5px; cursor: pointer; }
    button:hover { background: #005a9e; }
  </style>
  <script src="https://alcdn.msauth.net/browser/2.31.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h2>OneDrive File Editor</h2>

  <button id="signin">Login with Microsoft</button>
  <button id="load" disabled>Load File</button>
  <button id="save" disabled>Save Changes</button>

  <textarea id="editor" placeholder="File content will appear here..."></textarea>

  <script>
const msalConfig = {
    auth: {
        clientId: "2e6f2e23-c2e5-41d9-b310-d9d7ee25fd4d",
        authority: "https://login.microsoftonline.com/common/", 
        redirectUri: "http://localhost:5500/onedrive.html"
    }
};




    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginRequest = { scopes: ["Files.ReadWrite", "User.Read"] };

    let accessToken = null;
    let fileId = null;

    
    msalInstance.handleRedirectPromise().then(async (response) => {
      if (response) {
        msalInstance.setActiveAccount(response.account);
        accessToken = response.accessToken;
        alert("Login successful!");
        document.getElementById("load").disabled = false;
      }
    });

    // Login button
    document.getElementById("signin").onclick = () => {
      msalInstance.loginRedirect(loginRequest);
    };

    // Load file from OneDrive
    document.getElementById("load").onclick = async () => {
      if (!accessToken) return alert("Please login first.");

      const searchRes = await fetch("https://graph.microsoft.com/v1.0/me/drive/root/search(q='sample.txt')", {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const data = await searchRes.json();
      if (!data.value || data.value.length === 0) return alert("File not found.");

      fileId = data.value[0].id;
      const downloadUrl = data.value[0]["@microsoft.graph.downloadUrl"];
      const content = await fetch(downloadUrl).then(r => r.text());
      document.getElementById("editor").value = content;
      document.getElementById("save").disabled = false;
    };

    // Save back to OneDrive
    document.getElementById("save").onclick = async () => {
      if (!fileId) return alert("No file loaded.");

      const newContent = document.getElementById("editor").value;
      await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`, {
        method: "PUT",
        headers: { Authorization: `Bearer ${accessToken}` },
        body: new Blob([newContent], { type: "text/plain" })
      });

      alert("File saved successfully!");
    };
  </script>
</body>
</html>
